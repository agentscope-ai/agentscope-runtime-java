# Agent State Service

## Overview

**Agent State Service** is a core component used for **storing and managing agent serializable state**, allowing agents to maintain context information across multiple rounds or even across sessions.
Unlike **Session History Service**, which mainly stores text messages, **State Service** focuses more on storing agent internal **structured serializable data**, such as:

- Variable values
- Execution progress
- Intermediate results from tool usage
- Environment configuration or preferences, etc.

State Service organizes data according to the following dimensions:

- `userId`: Distinguishes users
- `sessionId`: Distinguishes sessions (default `"default"`)
- `roundId`: Distinguishes conversation rounds (optional, if omitted, automatically generates the latest round)

Roles during agent operation:

- **Save State** (`saveState`): Save the agent state at a certain moment
- **Restore State** (`exportState`): Restore previous state in the next round of conversation or next session

> State is a completely serializable dictionary, usually generated by the agent's state_dict() and can be directly loaded back (load_state_dict), facilitating encapsulation and cross-platform transmission.

## Usage in AgentScope

Unlike **Session History Service**, **Agent State Service** in AgentScope usually **does not require an adapter**. It can directly call `saveState` and `exportState` methods to persist and load state.

```{code-cell}
from agentscope_runtime.engine.services.agent_state import InMemoryStateService

# Initialize service
state_service = InMemoryStateService()
await state_service.start()

# Assume agent has state_dict method
agent_state = agent.state_dict()

# Save state (returns round_id)
round_id = await state_service.save_state(
    user_id="User1",
    session_id="TestSession",
    state=agent_state
)
print(f"State saved in round {round_id}")

# Export latest state (or specify round_id)
loaded_state = await state_service.export_state(
    user_id="User1",
    session_id="TestSession"
)
agent.load_state_dict(loaded_state)

```

## Optional Backend Implementation Types

Similar to session history, Agent State Service also has different storage backend implementations:

| Service Type                 | Import Path                                                     | Storage Location         | Persistence     | Production Ready | Characteristics                                                    | Use Cases                       |
| ------------------------ | ------------------------------------------------------------ | ---------------- | ---------- | ---------- | ------------------------------------------------------- | ------------------------------ |
| **InMemoryStateService** | `from agentscope_runtime.engine.services.agent_state import InMemoryStateService` | Process Memory         | ❌ No       | ❌          | Simple and fast, no external dependencies, data lost on process exit                | Development/Testing, Unit Tests             |
| **RedisStateService (under development)**    | `from agentscope_runtime.engine.services.agent_state import RedisStateService` | Redis In-Memory Database | ✅ Can Persist | ✅          | Supports distributed shared state, cross-process, Redis optional persistence (RDB/AOF) | High-performance Production Deployment, Cross-process Data Sharing |

## Switching Different Implementations

Since business code has consistent interfaces for `StateService`, switching backends is very simple; you only need to replace the instantiated type.

InMemory → Redis:

```{code-cell}
from agentscope_runtime.engine.services.agent_state import RedisStateService

state_service = RedisStateService(redis_url="redis://localhost:6379/0")
await state_service.start()

# Save state
await state_service.save_state(user_id="User1", session_id="ProdSession", state=agent.state_dict())

# Export state
state = await state_service.export_state(user_id="User1", session_id="ProdSession")
agent.load_state_dict(state)
```

## Selection Recommendations

- **Development Stage, Debugging or Testing**: `InMemoryStateService`, no external dependencies, fast iteration.
- **Production Environment, Need Cross-process Shared State**: `RedisStateService`, can be combined with Redis persistence and high-availability clustering.
- **Long Cycle and Strong Consistency, Auditing**: Consider implementing a database version of `StateService` yourself.

## Summary

- **Agent State Service** is responsible for saving serializable internal state, different from session history which only stores messages.
- Supports three-dimensional data organization: `user_id`, `session_id`, and `round_id`.
- In AgentScope, it is usually called directly without adapters.
- Switching storage backends is simple with unified interface definitions.
- Choose InMemory, Redis, or extend implementations as needed.
